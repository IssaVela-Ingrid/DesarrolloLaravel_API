<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de API Laravel (JWT & Roles)</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'custom-indigo': '#4f46e5',
                        'custom-green': '#10b981',
                        'custom-red': '#ef4444',
                    }
                }
            }
        }
    </script>
    <!-- Carga de Firebase (Firestore) para persistencia de token -->
    <script type="module">
        // Global variables MUST be used for Firebase setup
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        
        // Configuración de Logging para Debugging de Firestore
        setLogLevel('Debug');
        
        window.firebase = {};
        window.firebase.app = initializeApp(firebaseConfig);
        window.firebase.db = getFirestore(window.firebase.app);
        window.firebase.auth = getAuth(window.firebase.app);

        // Almacenamiento global para el token y user ID
        window.globalState = {
            token: null, // Se carga desde Firestore
            userId: null,
            db: window.firebase.db,
            appId: appId,
            // URL base de tu API de Laravel (Ajustar si es necesario)
            API_URL: 'http://localhost:8000/api' 
        };

        // FIREBASE: Ruta del documento de la sesión privada: /artifacts/{appId}/users/{userId}/session/token_data
        function getSessionDocRef(userId) {
            const db = window.globalState.db;
            return doc(db, `artifacts/${window.globalState.appId}/users/${userId}/session`, 'token_data');
        }

        async function saveTokenToFirestore(token, user) {
            if (!window.globalState.userId) return;
            try {
                await setDoc(getSessionDocRef(window.globalState.userId), {
                    jwt_token: token,
                    user: user || null,
                    timestamp: new Date().toISOString()
                });
                console.log("Token JWT guardado en Firestore.");
            } catch (e) {
                console.error("Error al guardar token en Firestore:", e);
            }
        }

        async function loadTokenFromFirestore() {
            if (!window.globalState.userId) return;
            try {
                const docSnap = await getDoc(getSessionDocRef(window.globalState.userId));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.jwt_token) {
                        window.globalState.token = data.jwt_token;
                        console.log("Token JWT cargado desde Firestore.");
                    }
                }
            } catch (e) {
                console.error("Error al cargar token desde Firestore:", e);
            }
        }
        
        async function clearTokenFromFirestore() {
            if (!window.globalState.userId) return;
            try {
                // Borrar solo el contenido, no el documento
                await setDoc(getSessionDocRef(window.globalState.userId), { jwt_token: null, user: null });
                console.log("Token JWT limpiado de Firestore.");
            } catch (e) {
                console.error("Error al limpiar token de Firestore:", e);
            }
        }

        // Función de autenticación inicial y obtención de userId
        async function initializeAuth() {
            try {
                if (initialToken) {
                    await signInWithCustomToken(window.firebase.auth, initialToken);
                } else {
                    await signInAnonymously(window.firebase.auth);
                }
                window.globalState.userId = window.firebase.auth.currentUser.uid;
                
                await loadTokenFromFirestore();
                
                // Asegura que la UI se actualice después de la carga del token
                if (typeof updateUI === 'function') {
                    updateUI(); 
                } else {
                    window.addEventListener('load', updateUI);
                }
                
            } catch (error) {
                console.error("Error al inicializar Firebase Auth:", error);
            }
        }
        
        initializeAuth();
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .container-card {
            background: white;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
        }
        .response-box {
            background-color: #1f2937; /* Dark background */
            color: #d1d5db; /* Light gray text */
            border-radius: 6px;
            padding: 10px;
            overflow-x: auto;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 0.85rem;
            max-height: 250px;
            border: 2px solid #e5e7eb; /* Default light border */
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-4xl mx-auto space-y-8">
        <header class="text-center">
            <h1 class="text-3xl font-bold text-gray-800">Panel de Pruebas de API (Laravel JWT & Rol)</h1>
            <p class="text-gray-500 mt-1">Simulación de Registro, Login y Protección de Rutas.</p>
        </header>

        <!-- Estado Global -->
        <div class="container-card p-4">
            <h2 class="text-xl font-semibold text-gray-700 mb-2">Estado de Autenticación</h2>
            <p class="text-sm text-gray-600 mb-3">
                <span class="font-bold">ID de Sesión (Firebase):</span> <span id="current-user-id" class="text-indigo-600 font-mono text-xs break-all">Cargando...</span>
            </p>
            <div class="flex items-center space-x-2 mb-3">
                <span class="font-bold text-sm">Token JWT Actual:</span>
                <span id="token-status" class="text-sm font-mono px-3 py-1 rounded-full"></span>
            </div>
            
            <!-- Info del Token Decodificado -->
            <div id="decoded-token-card" class="p-3 bg-gray-50 rounded-lg hidden">
                <h3 class="font-bold text-gray-700 text-base mb-1">Payload del Token (Decodificado)</h3>
                <div id="decoded-info" class="text-sm text-gray-800 space-y-0.5">
                    <!-- Contenido JS -->
                </div>
            </div>
        </div>

        <!-- Formularios de Autenticación -->
        <div class="grid md:grid-cols-2 gap-6">
            
            <!-- REGISTRO -->
            <div class="container-card p-6 space-y-4">
                <h2 class="text-2xl font-semibold text-custom-green">1. Registro (Rol: User por defecto)</h2>
                <form id="register-form" class="space-y-3">
                    <input type="text" id="reg-nombre" placeholder="Nombre" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-custom-indigo focus:border-custom-indigo" required>
                    <input type="email" id="reg-correo" placeholder="Correo" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-custom-indigo focus:border-custom-indigo" required>
                    <input type="password" id="reg-clave" placeholder="Clave (mín. 6 chars)" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-custom-indigo focus:border-custom-indigo" required>
                    <button type="submit" class="w-full bg-custom-green text-white p-2 rounded-lg hover:bg-green-600 transition duration-150 font-bold shadow-md hover:shadow-lg">
                        Registrar Usuario
                    </button>
                </form>
            </div>

            <!-- LOGIN -->
            <div class="container-card p-6 space-y-4">
                <h2 class="text-2xl font-semibold text-custom-indigo">2. Inicio de Sesión</h2>
                <form id="login-form" class="space-y-3">
                    <input type="email" id="log-correo" placeholder="Correo" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-custom-indigo focus:border-custom-indigo" required>
                    <input type="password" id="log-clave" placeholder="Clave" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-custom-indigo focus:border-custom-indigo" required>
                    <button type="submit" class="w-full bg-custom-indigo text-white p-2 rounded-lg hover:bg-indigo-600 transition duration-150 font-bold shadow-md hover:shadow-lg">
                        Iniciar Sesión y Obtener Token
                    </button>
                    <button type="button" id="logout-btn" class="w-full bg-custom-red text-white p-2 rounded-lg hover:bg-red-600 transition duration-150 font-bold shadow-md hover:shadow-lg">
                        Cerrar Sesión (Logout)
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Pruebas de Endpoints Protegidos -->
        <div class="container-card p-6 space-y-4">
            <h2 class="text-2xl font-semibold text-gray-700">3. Pruebas de Endpoints</h2>
            <div class="grid md:grid-cols-3 gap-4">
                <!-- Endpoint Protegido (JWT) -->
                <button id="test-me-btn" class="p-3 bg-yellow-500 text-white font-bold rounded-lg hover:bg-yellow-600 transition duration-150 shadow-md hover:shadow-lg">
                    <span class="block text-lg">GET /api/usuario/me</span>
                    <span class="text-xs font-normal opacity-80">(Requiere JWT)</span>
                </button>
                
                <!-- Endpoint Protegido por Rol (Admin) -->
                <button id="test-admin-btn" class="p-3 bg-fuchsia-600 text-white font-bold rounded-lg hover:bg-fuchsia-700 transition duration-150 shadow-md hover:shadow-lg">
                    <span class="block text-lg">GET /api/usuarios</span>
                    <span class="text-xs font-normal opacity-80">(Requiere Rol 'admin')</span>
                </button>

                <!-- Endpoint de Refresh -->
                <button id="test-refresh-btn" class="p-3 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 transition duration-150 shadow-md hover:shadow-lg">
                    <span class="block text-lg">POST /api/refresh</span>
                    <span class="text-xs font-normal opacity-80">(Refresca el Token)</span>
                </button>
            </div>
        </div>

        <!-- Área de Respuesta de la API -->
        <div class="container-card p-6">
            <h2 class="text-2xl font-semibold text-gray-700 mb-3">Respuesta de la API</h2>
            <div class="response-box">
                <pre id="api-response-output">Esperando acción...</pre>
            </div>
        </div>
    </div>

    <script>
        // ===============================================
        // LÓGICA DEL FRONTEND
        // ===============================================

        const API_URL = (typeof globalState !== 'undefined') ? globalState.API_URL : 'http://localhost:8000/api';

        // --- Utilidades del Token ---
        /**
         * Decodifica el payload de un token JWT (Base64Url).
         * @param {string} token
         * @returns {object|null}
         */
        function decodeToken(token) {
            if (!token) return null;
            try {
                // El token JWT tiene 3 partes: header.payload.signature
                const parts = token.split('.');
                if (parts.length !== 3) return null;

                // Decodificar el payload (Base64Url)
                const base64 = parts[1].replace(/-/g, '+').replace(/_/g, '/');
                // Agregar padding para atob si es necesario
                const paddedBase64 = base64.length % 4 === 0 ? base64 : base64 + '===='.slice(0, 4 - (base64.length % 4));
                
                const jsonPayload = decodeURIComponent(atob(paddedBase64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));

                return JSON.parse(jsonPayload);
            } catch (e) {
                console.error("Error al decodificar el token:", e);
                return null;
            }
        }

        // --- Utilidades de UI y Estado ---

        function updateUI() {
            const tokenStatusEl = document.getElementById('token-status');
            const decodedCardEl = document.getElementById('decoded-token-card');
            const decodedInfoEl = document.getElementById('decoded-info');
            
            const token = (typeof globalState !== 'undefined') ? globalState.token : null;

            if (token && token !== 'null') {
                tokenStatusEl.textContent = 'Token ACTIVO';
                tokenStatusEl.classList.remove('bg-gray-200', 'text-gray-800');
                tokenStatusEl.classList.add('bg-custom-green', 'text-white');
                decodedCardEl.classList.remove('hidden');

                const payload = decodeToken(token);
                if (payload) {
                    // Mostrar información clave del payload
                    const userRole = payload.role || 'user'; // Asume 'user' si no hay claim de rol
                    decodedInfoEl.innerHTML = `
                        <p><strong>ID Usuario (sub):</strong> <span class="text-indigo-600 font-mono">${payload.sub || 'N/A'}</span></p>
                        <p><strong>Rol:</strong> <span class="text-pink-500 font-bold">${userRole.toUpperCase()}</span></p>
                        <p><strong>Expira en:</strong> ${new Date(payload.exp * 1000).toLocaleString()}</p>
                        <p><strong>Emitido en:</strong> ${new Date(payload.iat * 1000).toLocaleString()}</p>
                        <details class="mt-2 text-xs text-gray-500">
                            <summary>Ver Payload Completo</summary>
                            <pre class="mt-1">${JSON.stringify(payload, null, 2)}</pre>
                        </details>
                    `;
                } else {
                    decodedInfoEl.innerHTML = '<p class="text-red-500">Token Inválido o Error de Decodificación.</p>';
                }

            } else {
                tokenStatusEl.textContent = 'Token INACTIVO';
                tokenStatusEl.classList.remove('bg-custom-green', 'text-white');
                tokenStatusEl.classList.add('bg-gray-200', 'text-gray-800');
                decodedCardEl.classList.add('hidden');
            }

            document.getElementById('current-user-id').textContent = (typeof globalState !== 'undefined' && globalState.userId) ? globalState.userId : 'No autenticado';
        }

        function displayResponse(data, status = 'success') {
            const outputEl = document.getElementById('api-response-output');
            const responseBoxEl = outputEl.parentElement;
            
            outputEl.innerHTML = JSON.stringify(data, null, 2);
            
            // Colores basados en el estado
            responseBoxEl.style.borderColor = 
                status === 'error' ? '#f87171' : 
                status === 'success' ? '#4ade80' : 
                '#9ca3af'; // info/loading
        }

        async function makeApiCall(url, method = 'GET', body = null) {
            displayResponse({ message: 'Llamando a la API...', url, method }, 'info');
            
            const headers = {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
            };
            
            // Adjuntar Token si está disponible
            const token = (typeof globalState !== 'undefined') ? globalState.token : null;
            if (token && token !== 'null') {
                headers['Authorization'] = `Bearer ${token}`;
            }

            try {
                // Implementación básica de reintentos con backoff (máx 3 intentos)
                let response = null;
                const maxRetries = 3;
                let lastError = null;

                for (let i = 0; i < maxRetries; i++) {
                    try {
                        response = await fetch(`${API_URL}${url}`, {
                            method: method,
                            headers: headers,
                            body: body ? JSON.stringify(body) : null,
                        });
                        break; // Éxito, salir del bucle
                    } catch (error) {
                        lastError = error;
                        if (i < maxRetries - 1) {
                            const delay = Math.pow(2, i) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                        }
                    }
                }
                
                if (!response) {
                     throw new Error(`Error de red después de ${maxRetries} intentos: ${lastError.message}`);
                }

                const data = await response.json();
                
                if (!response.ok) {
                    displayResponse({ status: response.status, statusText: response.statusText, data: data }, 'error');
                    return { success: false, status: response.status, data: data };
                }

                displayResponse({ status: response.status, data: data });
                return { success: true, status: response.status, data: data };

            } catch (error) {
                console.error("Error de red, CORS o Fetch:", error);
                displayResponse({ error: 'Error de red, CORS o configuración.', details: error.message }, 'error');
                return { success: false, data: { message: 'Error de red o CORS' } };
            }
        }
        
        // Función para actualizar el estado global del token y guardarlo
        function setToken(tokenData) {
            if (tokenData && tokenData.access_token) {
                // Actualizar estado global y Firestore
                if (typeof globalState !== 'undefined') {
                    globalState.token = tokenData.access_token;
                    saveTokenToFirestore(tokenData.access_token, tokenData.user);
                }
            } else {
                // Limpiar token
                if (typeof globalState !== 'undefined') {
                    globalState.token = null;
                    clearTokenFromFirestore();
                }
            }
            updateUI();
        }

        // --- Event Handlers ---
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nombre = document.getElementById('reg-nombre').value;
            const correo = document.getElementById('reg-correo').value;
            const clave = document.getElementById('reg-clave').value;

            const result = await makeApiCall('/register', 'POST', { nombre, correo, clave });

            if (result.success) {
                // El registro devuelve el token, lo guardamos.
                setToken(result.data);
            }
        });
        
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const correo = document.getElementById('log-correo').value;
            const clave = document.getElementById('log-clave').value;

            const result = await makeApiCall('/login', 'POST', { correo, clave });

            if (result.success) {
                setToken(result.data);
            } else {
                setToken(null);
            }
        });
        
        document.getElementById('logout-btn').addEventListener('click', async () => {
            const result = await makeApiCall('/logout', 'POST');
            // Incluso si el logout falla en la API, limpiamos el token localmente para forzar el re-login
            setToken(null);
        });

        document.getElementById('test-me-btn').addEventListener('click', async () => {
            await makeApiCall('/usuario/me', 'GET');
        });
        
        document.getElementById('test-admin-btn').addEventListener('click', async () => {
            // Asume que la ruta /api/usuarios requiere el rol 'admin'
            await makeApiCall('/usuarios', 'GET');
        });

        document.getElementById('test-refresh-btn').addEventListener('click', async () => {
            const result = await makeApiCall('/refresh', 'POST');
            if (result.success) {
                // La respuesta de refresh contiene un nuevo token
                setToken(result.data);
            }
        });
        
        // Asegura que la UI se actualice si el módulo de Firebase carga tarde
        if (typeof globalState !== 'undefined' && globalState.userId) {
             updateUI();
        }
    </script>

</body>
</html>
